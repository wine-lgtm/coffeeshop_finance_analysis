<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Manage Budget</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="side.css">

    <!-- FINAL layout fix -->
    <style>
           body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff; /* Plain white background, no color */
            margin: 0;
            padding: 0;
            color: #333;
            /* Disable scrolling and hide scrollbars for a clean look */
            overflow: hidden;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        body::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, and Opera */
        }
        #budget-page-standalone {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 40px;
            box-sizing: border-box;
            display: block;
                    border-radius: 28px;
        }

        /* Allow scrolling for main content, hide scroll bar visually */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #budget-page-standalone {
            max-height: 100vh;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
        }
        #budget-page-standalone::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }

        #budget-page-standalone table {
            width: 100%;
            border-collapse: collapse;
        }

        #budget-page-standalone th,
        #budget-page-standalone td {
            padding: 12px 14px;
            text-align: left;
        }
   #budget-page-standalone .card-grid {
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 22px;
            margin-top: 10px;
        }

        #budget-page-standalone .summary-card {
            box-sizing: border-box;
            padding: 36px; /* increase default card padding for larger visual frame */
        }
   .amount-cell {
            text-align: right;
            font-weight: 600;
            padding: 10px;
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum";
            white-space: nowrap;
            font-size: 16px;
        }

.currency {
    display: inline-block;
    width: auto;           /* let width adjust automatically */
    text-align: left;
    color: #555;
    margin-right: 10px;     /* small gap between $ and number */
}

.value {
    display: inline-block;
    min-width: 0;          /* no forced min-width */
    text-align: right;
}

            /* Styling for the heading to match the aesthetic brown theme */
        .dash-header h1 {
            font-size: 2.5rem;
            color: #8b4513; /* Brown color to match the boxes */
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold; /* Bold as requested */
             text-shadow:
                0 0 20px rgba(255, 179, 71, 0.55),
                0 0 40px rgba(255, 179, 71, 0.3);

        } 
        /* Styling for the month selector to match the aesthetic brown theme */
        .month-selector-container {
            margin: 10px 0 18px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            font-size: 1.2rem; /* make text bigger */
    padding: 10px 20px;
        }

        .month-selector-container label {
            font-weight: bold; /* Bold */
            color: #8b4513; /* Brown color to match theme */
            font-size: 1.1rem;
        }

        #month-selector {
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #daa520; /* Gold border to match boxes */
            background: #f4e4bc; /* Light brown background */
            font-size: 1rem;
            font-weight: bold; /* Bold */
            color: #654321; /* Dark brown text */
            transition: all 0.3s ease;
        }

        #month-selector:focus {
            outline: none;
            border-color: #ffd700; /* Brighter gold on focus */
            box-shadow: 0 0 8px rgba(218, 165, 32, 0.5); /* Gold glow */
            background: #fff; /* White on focus for contrast */
        }
            /* Enhanced visual styles for the three KPI boxes with aesthetic brown colors */
        .kpi-row .summary-card {
            flex: 1;
            min-width: 250px;
            padding: 50px 40px;
            background: linear-gradient(135deg, rgba(31, 13, 7, 0.96) 0%, #b06340 50%, #cd853f 100%); /* Deep brown gradient for aesthetics */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.3); /* Brown-tinted shadow for depth */
            text-align: center;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border: 3px solid #daa520; /* Gold border for visual pop */
        }

        .kpi-row .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(218, 165, 32, 0.4), transparent); /* Gold shimmer for visual effect */
            transition: left 0.6s;
        }

        .kpi-row .summary-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 40px rgba(139, 69, 19, 0.5);
            border-color: #ffd700; /* Brighter gold on hover */
        }

        .kpi-row .summary-card:hover::before {
            left: 100%;
        }

       .kpi-row .summary-card h4 {
            color: #f7e0c9; 
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            font-weight: 600;
            opacity: 0.9;
        }

        .kpi-row .summary-card .kpi-value {
            font-size: 1.9rem;
            color: #f7e0c9;
            font-weight: 700;
        }

        .kpi-row .summary-card div {
            font-size: 1.8rem;
            color: #ffffff;
            font-weight: bold; /* Bold */
        }

        /* Variance card specific: Aesthetic brown with subtle red tint for emphasis */
        .kpi-row .summary-card:nth-child(3) {
           background: linear-gradient(135deg, #aa6635 0%, #ae6644 50%, #c7884a 100%);/* Darker brown for variance */
        }

        .kpi-row .summary-card:nth-child(3) h4 {
            color: #ffffff; /* White for title */
        }

        .kpi-row .summary-card:nth-child(3) div {
            color: #ffffff; /* Light brown for value */
           
            
        }
        .card-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* exactly 2 columns */
    gap: 0; /* makes them touch */
}
 
         .card-grid .summary-card {
             width: 100%;
    min-height: 220px;

    padding: 40px 42px; 
        

            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-radius: 18px;
            border: 1px solid rgba(255, 179, 71, 0.35);
            background:
                radial-gradient(circle at top left, rgba(255, 209, 163, 0.22), transparent 60%),
                linear-gradient(135deg, rgba(31, 13, 7, 0.96), rgba(45, 21, 11, 0.98));
           box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.2),  /* softer main shadow */
        0 0 8px rgba(0, 0, 0, 0.1); 
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
            cursor: pointer;
        }

        .card-grid .summary-card h4 {
            font-size: 1.15rem;
            font-weight: 700;
            color:#f7e0c9;
            margin-bottom: 8px;
        }

        .card-grid .summary-card p {
            font-size: 0.94rem;
            color:#c9a58a;
            line-height: 1.5;
        }

        .card-grid .summary-card:hover {
            transform: translateY(-6px);
            box-shadow:
                0 24px 60px rgba(0, 0, 0, 0.9),
                0 0 36px rgba(255, 179, 71, 0.4);
            border-color: rgba(255, 179, 71, 0.85);
        }
  #budget-page-standalone .creamy-latte,
        #budget-page-standalone .mocha-light {
            background:
                radial-gradient(circle at top left, rgba(255, 209, 163, 0.22), transparent 60%),
                linear-gradient(135deg, rgba(31, 13, 7, 0.96), rgba(45, 21, 11, 0.98));
            color: var(--coffee-text-main);
        }
    .cta-button {
            margin-top: 12px;
            width: 100%;
            padding: 12px 0;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.12em;
            background: linear-gradient(90deg, #ffb347, #ffcc8f);
            color: #2b130d;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow:
                0 0 0 1px rgba(255, 179, 71, 0.4),
                0 12px 28px rgba(0, 0, 0, 0.55);
            transition:
                transform 0.2s ease,
                box-shadow 0.2s ease,
                filter 0.2s ease;
        }

        .cta-button:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
            box-shadow:
                0 0 0 1px rgba(255, 231, 199, 0.8),
                0 18px 46px rgba(0, 0, 0, 0.8);
        }

        .cta-button:active {
            transform: translateY(0);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
        }
/* Table row hover effect */
#category-table-body tr {
    transition: background 0.3s, transform 0.2s; /* smooth transition */
    cursor: pointer; /* indicate interactivity */
}

/* Gentle highlight on hover */
#category-table-body tr:hover {
    background: #f8fbff; /* soft light blue highlight */
    transform: scale(1.01); /* very subtle zoom */
}

/* Alternating row colors for readability */
#category-table-body tr:nth-child(even) {
    background: #f9f9f9;
}
#category-table-body tr:nth-child(odd) {
    background: #ffffff;
}


       

        
    </style>
</head>
<body>

<div id="budget-page-standalone">

    <header class="dash-header">
        <h1>Manage Budget</h1>
    </header>

    <!-- Compact month selector (doesn't change main frame layout) -->
    <div style="margin:10px 0 18px 0; display:flex; align-items:center; gap:12px;">
        <label for="month-selector" style="font-weight:600; color:#333;">Select month:</label>
        <input id="month-selector" type="month" style="padding:8px 10px; border-radius:6px; border:1px solid #ddd;" />
    </div>

    <!-- SUMMARY CARDS -->
    <!-- TOP KPI ROW -->
 <div class="kpi-row" style="display:flex; gap:20px; margin-bottom:18px;">
       <div class="summary-card kpi-card">
            <h4>Total Budgeted</h4>
            <div class="kpi-value">
                <span id="total-budgeted">$ 0</span>
            </div>
        </div>
        <div class="summary-card kpi-card">
            <h4>Total Actual Spent</h4>
            <div class="kpi-value">
                <span id="total-actual-spent">$ 0</span>
                <div id="labor-cost-info" style="font-size:1rem; color:#affbff; margin-top:6px; font-weight:500;"></div>
            </div>
        </div>
        <div class="summary-card kpi-card">
            <h4>Variance</h4>
            <div class="kpi-value">
                <span id="overall-variance"></span>
            </div>
        </div>
</div>
  <div class="card-grid">
        <div class="summary-card creamy-latte">
            <div>
                <h4>Company Budget</h4>
                <p>Manage overall company budget allocations and limits.</p>
            </div>
            <button class="cta-button" onclick="location.href='overall_budget.html'">
                Manage Budget
            </button>
        </div>

        <div class="summary-card mocha-light">
            <div>
                <h4>Category Budgets</h4>
                <p>Handle budgets for specific categories like marketing, operations, etc.</p>
            </div>
            <button class="cta-button" onclick="location.href='category_budget.html'">
                Manage Budget
            </button>
        </div>
    </div>

    <!-- CATEGORY BREAKDOWN (middle table with switch) -->
    <div style="margin-top:30px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 style="margin:0;">Budget Breakdown by Main Categories</h3>
            <div style="display:flex; gap:8px;">
                <button id="switch-cogs" style="padding:8px 12px; border-radius:8px; background:#ffb347; color:white; border:none; cursor:pointer;">COGS</button>
                <button id="switch-opex" style="padding:8px 12px; border-radius:8px; background:#eee; border:none; cursor:pointer; color:#000">Operating Expenses</button>
            </div>
        </div>

        <div style="background:white; border-radius:10px; padding:18px; border:1px solid #dbe7ff;">
            <div id="category-header" style="margin-bottom:12px; font-weight:600; color:#333"> </div>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#583932; color:white;">
                        <th style="padding:10px; text-align:left;">Subcategory</th>
                        <th style="padding:10px; text-align:left;">Budgeted</th>
                        <th style="padding:10px; text-align:left;">Actual Spent</th>
                        <th style="padding:10px; text-align:left;">Variance</th>
                        <th style="padding:10px; text-align:center;">Status</th>
                        <th style="padding:10px; text-align:center;">Alert</th>
                    </tr>
                </thead>
                <tbody id="category-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- KEY INSIGHTS -->
    <div id="key-insights" style="margin-top:30px; background: linear-gradient(180deg,#fff3c1,#ffe8a8); border-radius:10px; padding:18px; border:3px solid #ffd24d; box-shadow:0 6px 18px rgba(0,0,0,0.04);">
        <h3 style="color:#0b63c4; margin-top:0;">Key Insights</h3>


        <div id="insights-most-over" style="margin-bottom:10px; font-weight:bold; color:#c9302c;">Most Over-Budget Item: (loading...)</div>

        <div id="insights-summary" style="margin-bottom:10px; font: weight 900px;; color:#222;">Summary of Budget Status: (loading...)</div>

        <div id="insights-no-budget" style="margin-bottom:10px; color:#222;">Used but not budgeted: (loading...)</div>

        <div id="insights-alerts" style="margin-bottom:10px; color:#222;">Alerts: (loading...)</div>

        <div>
            <h4 style="margin:8px 0 6px 0;">Recommendations:</h4>
            <ul id="insights-recommendations" style="margin:0 0 0 18px; color:#222;"><li>Recommendations: (loading...)</li></ul>
        </div>
    </div>

    <!-- COMPANY BUDGET SECTION -->
    <div id="company-budget-section" class="manage-expense-card" style="display:none; margin-top:30px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="company-form-title">Add Company Budget</h3>
            <div style="display:flex; gap:10px;">
                <input type="month" id="company_month_filter">
                <button onclick="loadCompanyBudgets()" class="add-expense-btn">Filter</button>
            </div>
        </div>

        <input type="hidden" id="company_budget_id">

        <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:15px;">
            <input type="month" id="company_budget_month">
            <input type="number" id="company_budget_amount" placeholder="0.00">
            <div style="display:flex; gap:5px;">
                <button onclick="saveCompanyBudget()" class="add-expense-btn">Save</button>
                <button onclick="clearCompanyForm()" id="btn-cancel-edit-company"
                        style="display:none; background:#999; color:white; border:none;
                               padding:0 15px; border-radius:14px;">
                    Cancel
                </button>
            </div>
        </div>

        <h3 style="margin-top:30px;">Company Budget List</h3>
        <table>
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Total Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="company-budget-table-body"></tbody>
        </table>
    </div>


</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="newscript.js?v=5"></script>
<script src="budget_script.js?v=5"></script>
<script src="budget.js?v=5"></script>
<script src="company_budget.js?v=5"></script>

<script>
    // Fixed API base so it works from both localhost and Go Live (127.0.0.1). Backend must run on port 8000.
    const API_BASE = 'http://127.0.0.1:8000';

    // Populate the top KPI blocks for the selected month (falls back to current month)
    let selectedMonth = null; // format YYYY-MM
    let currentCategory = 'COGS';

    function _getCurrentMonthRange() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const currentMonth = `${y}-${m}`;
        const effective = selectedMonth || currentMonth;
        const [ey, em] = effective.split('-').map(v => parseInt(v, 10));
        const month = `${String(ey)}-${String(em).padStart(2, '0')}`;
        const start = `${month}-01`;
        const lastDay = new Date(ey, em, 0).getDate();
        const end = `${month}-${String(lastDay).padStart(2, '0')}`;
        return { month, start, end };
    }

    async function updateTopKPIs() {
        const elBudgeted = document.getElementById('total-budgeted');
        const elActual = document.getElementById('total-actual-spent');
        const elVar = document.getElementById('overall-variance');
        if (!elBudgeted || !elActual || !elVar) return;

        const { month, start, end } = _getCurrentMonthRange();

        // 1) Total Budgeted: sum of admin overall budgets for current month
        let totalBudgeted = 0;
        try {
            const res = await fetch(`${API_BASE}/api/overall_budgets?month=${month}`);
            if (res.ok) {
                const budgets = await res.json();
                // overall_budgets may return one or more rows; sum their amounts
                totalBudgeted = budgets.reduce((s, b) => s + parseFloat(b.amount || 0), 0);
            }
        } catch (e) { console.error('Failed to load overall budgets for KPI:', e); }
        elBudgeted.innerText = `$ ${totalBudgeted.toLocaleString()}`;

        // 2) Total Actual Spent (use financial-summary breakdown for month)
        let actualSpent = 0;
        let laborCost = 0;
        let latestLaborCost = null;
        try {
            const sumRes = await fetch(`${API_BASE}/api/financial-summary?start_date=${start}&end_date=${end}`);
            if (sumRes.ok) {
                const data = await sumRes.json();
                const breakdown = data.breakdown || {};
                const cogs = parseFloat(breakdown.cogs || 0);
                const operating = parseFloat(breakdown.operating || 0);
                laborCost = parseFloat(breakdown.payroll || 0);
                actualSpent = cogs + operating;
            }
        } catch (e) { console.error('Failed to load financial summary:', e); }

        // Fetch sum of labor cost entries from admin for the selected month onlyz
        let laborCostSum = null;
        try {
            const sumLaborRes = await fetch(`${API_BASE}/api/sum-labor-cost?month=${month}`);
            if (sumLaborRes.ok) {
                const sumLaborData = await sumLaborRes.json();
                if (sumLaborData.labor_cost_sum !== null && !isNaN(sumLaborData.labor_cost_sum)) {
                    laborCostSum = parseFloat(sumLaborData.labor_cost_sum);
                }
            }
        } catch (e) { console.error('Failed to load sum labor cost:', e); }

        // Prefer laborCost (payroll sum for month) if available, else admin sum for this month
        let showValue = null;
        if (laborCost !== 0) {
            showValue = laborCost;
        } else if (laborCostSum !== null && laborCostSum !== 0) {
            showValue = laborCostSum;
        }

        elActual.innerText = `$ ${actualSpent.toLocaleString()}`;
        const laborInfo = document.getElementById('labor-cost-info');
        if (laborInfo) {
            if (showValue !== null) {
                laborInfo.innerText = `Labor Cost: $ ${showValue.toLocaleString()}`;
            } else {
                laborInfo.innerText = '';
            }
        }

        // 3) Variance
        const variance = totalBudgeted - actualSpent;
        const percent = totalBudgeted ? (variance / totalBudgeted) * 100 : 0;
        const absVar = Math.abs(variance);
        const status = variance >= 0 ? 'Under Budget' : 'Over Budget';
        const sign = variance >= 0 ? '' : '-';
        elVar.innerHTML = `${sign}$ ${absVar.toLocaleString()} <div style="font-size:0.9rem; color:#666; margin-top:6px;">(${Math.abs(percent).toFixed(1)}% ${status})</div>`;
    }

    // Key Insights: call backend /api/key-insights and render results with errors shown
    async function updateKeyInsights() {
        const mostEl = document.getElementById('insights-most-expensive');
        const sumEl = document.getElementById('insights-summary');
        const alertsEl = document.getElementById('insights-alerts');
        const recEl = document.getElementById('insights-recommendations');
        let topOverMention = null;
        try {
            const { month, start, end } = _getCurrentMonthRange();
            const url = `${API_BASE}/api/key-insights?start_date=${start}&end_date=${end}&month=${month}&sales_only=true&source=both`;
            const res = await fetch(url);
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || `${res.status} ${res.statusText}`);
            }
            const data = await res.json();

            // Most expensive
       

            // Most over-budget (by overrun amount)
            const mostOverEl = document.getElementById('insights-most-over');
            try {
                const allEntries = data.entries || [];
                const overEntries = allEntries
                    .filter(e => {
                        if (!e) return false;
                        const rawSub = (e.subcategory != null) ? String(e.subcategory).trim() : '';
                        const rawCat = (e.category != null) ? String(e.category).trim() : '';
                        const lowerSub = rawSub.toLowerCase();
                        const lowerCat = rawCat.toLowerCase();
                        // treat empty, explicit main markers, or subcategory equal to category as main/overall rows
                        const isMain = (rawSub === '') || lowerSub === '(main)' || lowerSub === 'main' || lowerSub === lowerCat;
                        if (isMain) return false;
                        return e.status === 'Over Budget' && (Number(e.actual || 0) > 0);
                    })
                    .map(e => ({...e, overrun: Number((Number(e.actual || 0) - Number(e.budgeted || 0)).toFixed(2))}));
                overEntries.sort((a,b) => b.overrun - a.overrun);
                if (mostOverEl) {
                    if (!overEntries || overEntries.length === 0) {
                        mostOverEl.innerText = 'Most Over-Budget Item: No over-budget items this month.';
                    } else {
                        const top = overEntries[0];
                        console.debug('Top over-entry (debug):', top);
                        const rawActual = Number(top.actual || 0);
                        const computedActual = Number(top.budgeted || 0) + Number(top.overrun || 0);
                        let displayedActual = 0;
                        if (rawActual && computedActual) {
                            // If rawActual is approx exactly double the computedActual, assume doubling bug and halve it
                            if (Math.abs(rawActual - computedActual) < 0.5) displayedActual = rawActual / 2;
                            else displayedActual = rawActual;
                        } else {
                            displayedActual = rawActual || computedActual || 0;
                        }
                        mostOverEl.innerHTML = `Most Over-Budget Item: ${top.category || 'Unknown'} / ${top.subcategory || '(main)'} —  (Budgeted: $ ${Number(top.budgeted || 0).toLocaleString()}, Actual: $ ${Number(displayedActual).toLocaleString()})`;
                        // prepare a recommended mention for the top over-budget item (rendered later)
                        topOverMention = `Focus on the over-budget item (${top.category} / ${top.subcategory || '(main)'}). Consider delaying non-essential purchases.`;
                    }
                }
            } catch (e) {
                if (mostOverEl) mostOverEl.innerText = 'Most Over-Budget Item: (error computing overrun)';
            }

            // Summary — compute client-side from returned entries to avoid backend mismatch
            if (sumEl) {
                const entries = data.entries || [];
                const summaryCounts = {
                    'Under Budget': {count: 0, total: 0},
                    'Over Budget': {count: 0, total: 0},
                    'No Budget Creation': {count: 0, total: 0}
                };

                entries.forEach(e => {
                    // Exclude top-level main-category rows and any entries with empty/blank subcategory
                    const subcat = (e.subcategory != null && String(e.subcategory).trim() !== '') ? String(e.subcategory).trim() : null;
                    if (!subcat) return; // skip main rows / empty subcategory entries

                    const budgeted = Number(e.budgeted || 0);
                    const actual = Number(e.actual || 0);
                    const variance = budgeted - actual;

                    // Determine status strictly from variance (ignore backend-provided status)
                    let st;
                    if (!e.budgeted || budgeted === 0) st = 'No Budget Creation';
                    else st = (variance < 0) ? 'Over Budget' : 'Under Budget';

                    if (st === 'Under Budget') {
                        summaryCounts['Under Budget'].count += 1;
                        summaryCounts['Under Budget'].total += Math.max(0, variance);
                    } else if (st === 'Over Budget') {
                        summaryCounts['Over Budget'].count += 1;
                        summaryCounts['Over Budget'].total += Math.max(0, -variance);
                    } else if (st === 'No Budget Creation') {
                        summaryCounts['No Budget Creation'].count += 1;
                        summaryCounts['No Budget Creation'].total += actual;
                    }
                });

                const ub = summaryCounts['Under Budget'];
                const ob = summaryCounts['Over Budget'];

                // Recalculate total overrun by aggregating budgets and actuals per (category+subcategory)
                let explicitOverrunTotal = 0;
                try {
                    // build budget map from entries: key -> total budgeted
                    const budgetMap = {};
                    (entries || []).forEach(e => {
                        const subcat = (e.subcategory != null && String(e.subcategory).trim() !== '') ? String(e.subcategory).trim() : null;
                        if (!subcat) return;
                        const catRaw = (e.category != null) ? String(e.category).trim().toLowerCase() : '';
                        const key = `${catRaw.toLowerCase()}||${subcat}`;
                        budgetMap[key] = (budgetMap[key] || 0) + Number(e.budgeted || 0);
                    });

                    // fetch aggregated actuals from backend (avoid per-entry duplication)
                    const expRes = await fetch(`${API_BASE}/api/expense-by-subcategory?start_date=${start}&end_date=${end}&sales_only=true&source=reporting`);
                    const expMap = {};
                    if (expRes.ok) {
                        const expList = await expRes.json();
                        expList.forEach(it => {
                            const catKey = (it.category != null) ? String(it.category).trim().toLowerCase() : '';
                            const sub = (it.subcategory != null) ? String(it.subcategory).trim() : '';
                            if (!sub) return;
                            const key = `${catKey}||${sub}`;
                            expMap[key] = (expMap[key] || 0) + Number(it.total || 0);
                        });
                    }

                    // compute overrun per unique key where budget > 0
                    Object.keys(budgetMap).forEach(k => {
                        const budgeted = budgetMap[k] || 0;
                        const actual = expMap[k] || 0;
                        if (budgeted > 0 && actual > budgeted) {
                            explicitOverrunTotal += (actual - budgeted);
                        }
                    });
                } catch (err) {
                    console.error('Failed to compute explicitOverrunTotal:', err);
                }

                sumEl.innerHTML = `Summary of Budget Status:<br>` +
                    `- <span style="color:green; font-weight:700;">Under Budget:</span> ${ub.count} subcategories — Total savings: $ ${Math.round(ub.total).toLocaleString()}.<br>` +
                    `- <span style="color:#c9302c; font-weight:700;">Over Budget:</span> ${ob.count} subcategories — Total overrun: $ ${Math.round(explicitOverrunTotal).toLocaleString()}.`;

                // Also show no-budget creation count separately (unique subcategory counts)
                const noBudgetEl = document.getElementById('insights-no-budget');
                if (noBudgetEl) {
                    // Track unique subcategories globally and per main category
                    const noBudgetGlobal = new Set();
                    const noBudgetByCat = {
                        'COGS': {subs: new Set(), total: 0},
                        'Operating expense': {subs: new Set(), total: 0}
                    };

                    (data.entries || []).forEach(e => {
                        const subcat = (e.subcategory != null && String(e.subcategory).trim() !== '') ? String(e.subcategory).trim() : null;
                        if (!subcat) return; // skip main rows

                        const budgeted = Number(e.budgeted || 0);
                        const actual = Number(e.actual || 0);
                        const catRaw = (e.category != null) ? String(e.category).trim().toLowerCase() : '';

                        let key = null;
                        if (catRaw.includes('cogs')) key = 'COGS';
                        else if (catRaw.includes('operat')) key = 'Operating expense';

                        if (!budgeted || budgeted === 0) {
                            // only count COGS and Operating expense subcategories (ignore other categories)
                            if (!key) return;
                            const globalKey = `${key}||${subcat}`;
                            if (!noBudgetGlobal.has(globalKey)) {
                                noBudgetGlobal.add(globalKey);
                            }
                            if (!noBudgetByCat[key].subs.has(subcat)) {
                                noBudgetByCat[key].subs.add(subcat);
                                noBudgetByCat[key].total += actual;
                            }
                        }
                    });

                    noBudgetEl.innerHTML = `Used but not budgeted: ${noBudgetGlobal.size} subcategories total — ` +
                        `COGS:   ${noBudgetByCat['COGS'].subs.size} subcategories ,   ` +
                        `Operating expense:   ${noBudgetByCat['Operating expense'].subs.size} subcategories .`;
                }
            }

            // Alerts
            if (alertsEl) {
                alertsEl.innerHTML = `Alerts: ${data.alerts || 0} active alert(s). Review over-budget items to avoid further overruns.`;
            }

            // Recommendations
            if (recEl) {
                const recs = data.recommendations || [];
                if (recs.length === 0) recEl.innerHTML = '<li>No recommendations available.</li>';
                else recEl.innerHTML = recs.map(r => `<li>${r}</li>`).join('');
            }

        } catch (err) {
            console.error('Failed to load key insights:', err);
            const msg = (err && err.message) ? err.message : 'Failed to load key insights.';
           
            if (sumEl) sumEl.innerText = `Summary of Budget Status: ${msg}`;
            if (alertsEl) alertsEl.innerText = `Alerts: ${msg}`;
            if (recEl) recEl.innerHTML = `<li>${msg}</li>`;
        }
    }

    // Normalize API category to budget category key (e.g. "Operating Expense" -> "Operating expense")
    function _normalizeCategory(cat) {
        if (!cat) return '';
        const c = String(cat).trim();
        if (c.toLowerCase() === 'operating expense') return 'Operating expense';
        return c;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // initialize month selector input (compact control)
        const monthInput = document.getElementById('month-selector');
        if (monthInput) {
            // default to current month in YYYY-MM
            const now = new Date();
            const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            selectedMonth = defaultMonth;
            monthInput.value = defaultMonth;
            monthInput.addEventListener('change', function() {
                if (this.value) selectedMonth = this.value;
                updateTopKPIs();
                loadCategoryBreakdown(currentCategory);
                updateKeyInsights();
            });
        }

        // run after page load; also refresh when budgets change if needed
        updateTopKPIs();
        updateKeyInsights();
        // refresh periodically in case background edits occur
        setInterval(updateTopKPIs, 60000);
        setInterval(updateKeyInsights, 60000);

        // ---- Category breakdown table and switches ----
        const btnCogs = document.getElementById('switch-cogs');
        const btnOpex = document.getElementById('switch-opex');
        const tbody = document.getElementById('category-table-body');
        const headerEl = document.getElementById('category-header');
        if (!btnCogs || !btnOpex || !tbody || !headerEl) return;

        async function loadCategoryBreakdown(categoryKey) {
            // categoryKey should be 'COGS' or 'Operating expense'
            const { month, start, end } = _getCurrentMonthRange();
            headerEl.innerText = `1. ${categoryKey === 'COGS' ? 'COGS (Cost of Goods Sold)' : 'Operating expense (Operating Expenses)'} for ${month}`;

            // fetch budgets for month
            let budgets = [];
            try {
                const res = await fetch(`${API_BASE}/api/budgets?month=${month}`);
                if (res.ok) budgets = await res.json();
            } catch (e) { console.error('Failed to fetch budgets:', e); }

            // filter rows for selected main category (case-insensitive match to avoid minor casing/wording differences)
            const rows = budgets.filter(b => String(b.category || '').trim().toLowerCase() === String(categoryKey || '').trim().toLowerCase());

            // compute total budgeted for this main category
            const totalBudgeted = rows.reduce((s, r) => s + parseFloat(r.amount || 0), 0);

            // fetch actual spent per subcategory from daily expense entries (only expense records, summed by subcategory)
            // start/end already available from earlier call
            let actualBySubcategory = {};
            try {
                const expRes = await fetch(`${API_BASE}/api/expense-by-subcategory?start_date=${start}&end_date=${end}&sales_only=true&source=reporting`);
                if (expRes.ok) {
                    const expList = await expRes.json();
                    const byCat = {};
                    expList.forEach(item => {
                        const catKey = _normalizeCategory(item.category);
                        if (catKey !== categoryKey) return;
                        const sub = (item.subcategory != null && item.subcategory !== '') ? String(item.subcategory).trim() : '';
                        if (!byCat[sub]) byCat[sub] = 0;
                        byCat[sub] += parseFloat(item.total || 0);
                    });
                    actualBySubcategory = byCat;
                }
            } catch (e) { console.error('Failed to fetch expense-by-subcategory:', e); }

            tbody.innerHTML = '';
            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:16px;">No budgets found for ${month} / ${categoryKey}</td></tr>`;
                return;
            }

            // Build complete subcategory list: prefer known allowedSubcategoriesByCategory (from budget.js) when available
            let subList = [];
            try {
                const allowed = (typeof allowedSubcategoriesByCategory !== 'undefined') ? allowedSubcategoriesByCategory[categoryKey] || [] : [];
                subList = Array.from(new Set([
                    ...(allowed || []),
                    ...rows.map(r => r.subcategory).filter(s => s && String(s).trim() !== ''),
                    ...Object.keys(actualBySubcategory).filter(s => s !== '')
                ]));
            } catch (e) {
                subList = Array.from(new Set([
                    ...rows.map(r => r.subcategory).filter(s => s && String(s).trim() !== ''),
                    ...Object.keys(actualBySubcategory).filter(s => s !== '')
                ]));
            }

            // Sum of actuals for this category (for main row)
            const actualMain = Object.keys(actualBySubcategory).reduce((sum, sub) => sum + (actualBySubcategory[sub] || 0), 0);

            // If there's a main category budget (no subcategory), show it first
            const mainRow = rows.find(r => r.subcategory === null || r.subcategory === undefined || String(r.subcategory).trim() === '');
            if (mainRow) {
                const budgeted = parseFloat(mainRow.amount || 0);
                const actual = Math.round(actualMain * 100) / 100;
                const variance = Math.round((budgeted - actual) * 100) / 100;
                const percent = budgeted ? (Math.abs(variance) / budgeted) * 100 : 0;
                // Any negative variance (actual > budget) is Over Budget; otherwise Under Budget
                let status = (variance < 0) ? 'Over Budget' : 'Under Budget';
                const tr = document.createElement('tr');
                const alertText = (status === 'Over Budget') ? '<span style="color:#c9302c; font-weight:700;">Over Budget Alert</span>' : '<span style="color:#2ea44f; font-weight:700;">OK</span>';
                tr.innerHTML = `
                    <td style="padding:10px">${mainRow.category} (Main)</td>
                <td class="amount-cell">
        <span class="currency">$</span>
        <span class="value">${budgeted.toLocaleString()}</span>
    </td>

    <td class="amount-cell">
        <span class="currency">$</span>
        <span class="value">${actual.toLocaleString()}</span>
    </td>

    <td class="amount-cell">
        <span class="currency">$</span>
        <span class="value">${variance.toLocaleString()}</span>
    </td>
                   <td style="padding:10px; text-align:center; font-size:15px;">
    ${status === 'No Budget Creation' 
        ? '<span style="display: inline-block; background-color: #ffe2b8; color: black;padding: 4px 12px;         border-radius: 12px;      font-weight: bold;font-size: 15px;text-align: center;">No Budget Creation</span>'
        : status === 'Under Budget'
            ? '<span>Under Budget</span>'
            : '<span style="color:#c9302c; font-weight:bold;">Over Budget</span>'
    }
</td>
                    <td style="padding:10px; text-align:center">${alertText}</td>
                `;
                tbody.appendChild(tr);
            }

            // For each subcategory: actual spent = sum of expense records in that sub-category (from daily entries)
            subList.forEach(sub => {
                const r = rows.find(rr => String(rr.subcategory) === String(sub));
                const hasBudget = !!r;
                const budgeted = hasBudget ? parseFloat(r.amount || 0) : 0;
                const actual = Math.round((actualBySubcategory[sub] || 0) * 100) / 100;
                const variance = Math.round((budgeted - actual) * 100) / 100;
                const percent = budgeted ? (Math.abs(variance) / budgeted) * 100 : 0;
                let status = '';
                if (!hasBudget) {
                    status = 'No Budget Creation';
                } else {
                    // Any negative variance (actual > budget) is Over Budget; otherwise Under Budget
                    status = (variance < 0) ? 'Over Budget' : 'Under Budget';
                }
                const tr = document.createElement('tr');
                const alertText = (status === 'Over Budget') ? '<span style="color:#c9302c; font-weight:700;">Over Budget Alert</span>' : '<span style="color:#2ea44f; font-weight:700;">OK</span>';
                tr.innerHTML = `
                    <td style="padding:10px">${sub}</td>
                    <td class="amount-cell">
        <span class="currency">$</span>
        <span class="value">${budgeted.toLocaleString()}</span>
    </td>

    <td class="amount-cell">
        <span class="currency">$</span>
        <span class="value">${actual.toLocaleString()}</span>
    </td>

    <td class="amount-cell">
        <span class="currency">$</span>
        <span class="value">${variance.toLocaleString()}</span>
    </td>
                <td style="padding:10px; text-align:center; font-size:14px;">
    ${status === 'No Budget Creation' 
        ? '<span style="display: inline-block; background-color: #ffe2b8; color: black;padding: 4px 12px;         border-radius: 12px;    font-size: 14px;text-align: center;">No Budget Creation</span>'
        : status === 'Under Budget'
            ? '<span>Under Budget</span>'
            : '<span style="color:#c9302c; font-weight:bold;">Over Budget</span>'
    }
</td>
                    <td style="padding:10px; text-align:center">${alertText}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // set up switch buttons
        btnCogs.addEventListener('click', function() {
            btnCogs.style.background = '#ffb347'; btnCogs.style.color = '#fff';
            btnOpex.style.background = '#eee'; btnOpex.style.color = '#000';
            currentCategory = 'COGS';
            loadCategoryBreakdown('COGS');
        });
        btnOpex.addEventListener('click', function() {
            btnOpex.style.background = '#ffb347'; btnOpex.style.color = '#fff';
            btnCogs.style.background = '#eee'; btnCogs.style.color = '#000';
            currentCategory = 'Operating expense';
            loadCategoryBreakdown('Operating expense');
        });

        // initial load
        loadCategoryBreakdown('COGS');
    });
</script>


</body>
</html>